apiVersion: batch/v1
kind: Job
metadata:
  name: lldap-bootstrap
  namespace: auth
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: bootstrap
        image: nitnelave/lldap:2025-04-25-alpine
        command: ["/bin/sh", "-c"]
        args:
          - |
            if [ -f /data/lldap.db ]; then
              echo "Database already exists. Skipping bootstrap.";
              exit 0;
            fi

            echo "Database not found. Running bootstrap...";
            /app/bootstrap.sh
        env:
        - name: LLDAP_URL
          value: "http://localhost:8080"
        - name: LLDAP_ADMIN_USERNAME
          value: "admin"
        - name: LLDAP_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: lldap-secrets
              key: ldap-user-pass
        - name: DO_CLEANUP
          value: "true"
        volumeMounts:
        - name: user-configs
          mountPath: /bootstrap/user-configs
          readOnly: true
        - name: group-configs
          mountPath: /bootstrap/group-configs
          readOnly: true
        - name: data
          mountPath: /data
      volumes:
      - name: user-configs
        projected:
          sources:
          - secret:
              name: lldap-secrets
              items:
              - key: admin-user-config.json
                path: admin-user-config.json
      - name: group-configs
        projected:
          sources:
          - secret:
              name: lldap-secrets
              items:
              - key: admin-group-config.json
                path: admin-group-config.json
      - name: data
        nfs:
          server: ${NFS1_SERVER}
          path: /volume1/kubernetes/data/lldap